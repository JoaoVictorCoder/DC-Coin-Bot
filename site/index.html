<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coin Bank</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    /* Corpo agora permite scroll completo e mant√©m conte√∫do centralizado horizontalmente */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #36393f;
      color: #dcddde;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
      min-height: 100vh;
      overflow-y: auto;
    }

    /* Modais de login/register CENTRALIZADOS em full height */
    #loginModal,
    #registerModal {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #loginModal.active,
    #registerModal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    /* Tela principal CENTRALIZADA em viewport mas scroll√°vel no body */
    #mainScreen {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }
    #mainScreen.active {
      display: flex;
      align-items: center; /* centraliza vertical */
      justify-content: center;
      flex-direction: column;
      padding: 100px 0; /* espa√ßo acima/abaixo */
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 420px;
    }

    /* make modal cards same width as main container */
    .modal .card {
      width: 420px;
    }
    .container > .card {
      width: 100%;
      box-sizing: border-box;
    }

    .card {
      background: #2f3136;
      border-radius: 8px;
      padding: 20px;
      position: relative;
    }

    .btn {
      background: #7289da;
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s, transform 0.06s;
      font-weight: 600;
    }
    .btn:active { transform: translateY(1px); }
    .btn.disabled {
      background: #72767d;
      cursor: default;
    }
    .btn.enabled {
      background: #43b581;
    }
    .btn-reset {
      background: #ff5c5c;
      margin-top: 12px;
    }

    .nav {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .nav .btn {
      flex: 1;
    }

    #dynamic {
      background: #2f3136;
      border-radius: 8px;
      padding: 20px;
      height: 500px;
      overflow-y: auto;
      margin-top: 8px;
    }

    /* Footer card igual largura dos modais e centralizado */
    .modal #footerCard {
      width: 460px;
      margin: 16px auto 0 auto;
    }
    #footerCard {
      background: #2f3136;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-sizing: border-box;
      width: 100%;
    }

    .field {
      margin-bottom: 12px;
    }
    .field input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: none;
      box-sizing: border-box;
    }

    .tx,
    .bill {
      background: #202225;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 12px;
      white-space: pre-line;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .tx .left,
    .bill .left { flex: 1; }

    .highlight {
      color: #8f8f8f;
    }

    #cardDisplay {
      display: flex;
      justify-content: center;
    }
    .bank-card {
      background: #1e1e1e;
      border-radius: 12px;
      width: 300px;
      height: 180px;
      position: relative;
      color: #fff;
    }
    .bank-card .magstripe {
      position: absolute;
      top: 20px;
      left: 0;
      width: 100%;
      height: 32px;
      background: #000;
    }
    .bank-card .info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      font-size: 14px;
      line-height: 1.2;
    }

    .balance-box {
      background: #23272a;
      padding: 8px;
      border-radius: 4px;
      text-align: right;
      margin: 12px 0;
      font-size: 20px;
    }

    #userBtn,
    #settingsBtn {
      position: absolute;
      top: 16px;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      font-size: 18px;
      line-height: 32px;
      text-align: center;
      cursor: pointer;
    }
    #userBtn {
      right: 16px;
      background: #43b581;
    }
    #settingsBtn {
      right: 56px;
      background: #7289da;
    }
    /* new tx button */
    #txBtn {
      position: absolute;
      top: 16px;
      right: 96px;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      font-size: 16px;
      line-height: 32px;
      text-align: center;
      cursor: pointer;
      background: #cfcfcf;
      color: #111;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
    }

    .single-tx-placeholder {
      background: #000;         /* black as requested */
      color: #fff;
      border-radius: 4px;
      padding: 12px;
      min-height: 80px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      font-family: monospace;
      white-space: pre-wrap;
      position: relative; /* allows inner copy button to position */
    }

    /* COPY BUTTON style: softer green, rounded, more modelled */
    .copy-btn {
      background: linear-gradient(180deg,#9fe6c8,#66d398);
      color: #ffffff;
      border: none;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 6px 14px rgba(17,100,61,0.16), inset 0 -2px 0 rgba(255,255,255,0.08);
      transition: transform 0.06s, opacity 0.12s;
    }
    .copy-btn:active { transform: translateY(1px); }
    .copy-btn.small { padding:6px 8px; border-radius:8px; font-weight:600; font-size:13px; }

    /* RED variant for reset (same shape but red soft gradient) */
    .copy-btn.red {
      background: linear-gradient(180deg,#ffb3b3,#ff6b6b);
      color: #3b0505;
      box-shadow: 0 6px 14px rgba(110,16,16,0.12), inset 0 -2px 0 rgba(255,255,255,0.06);
    }

    .copy-inline {
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* small responsive tweak */
    @media (max-width: 480px) {
      .container { width: 92%; }
      .bank-card { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="modal active">
    <div class="card">
      <h2>Login</h2>
      <div class="field"><input id="loginUser" placeholder="Username" /></div>
      <div class="field">
        <input id="loginPass" type="password" placeholder="Password" />
      </div>
      <button id="loginBtn" class="btn">Login</button>
      <button id="goRegisterBtn" class="btn">Register</button>
    </div>
    <div id="footerCard" class="card">
        <div>
          <a
            href="https://discord.com/oauth2/authorize?client_id=1391067775077978214"
            style="color: #7289da; text-decoration: none; font-weight: bold;";
            >Install Discord Bot</a
          >
        </div>
        <div>
          <a href="/terms" style="color: #7289da; text-decoration: none">Terms Of Use</a>
          &amp;
          <a href="/terms/documentation.html" style="color: #7289da; text-decoration: none">API Docs</a>
          &amp;
          <a href="/terms/privacy.html" style="color: #7289da; text-decoration: none">Privacy Policy</a>
        <div>Coin System ¬© since 2025</div>
        </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal">
    <div class="card">
      <h2>Register</h2>
      <div class="field"><input id="regUser" placeholder="Username" /></div>
      <div class="field">
        <input id="regPass" type="password" placeholder="Password" />
      </div>
      <div class="field">
        <input id="regConfirm" type="password" placeholder="Confirm Password" />
      </div>
      <button id="registerBtn" class="btn">Register</button>
      <button id="backBtn" class="btn">Back</button>
    </div>
    <div id="footerCard" class="card">
        <div>
          <a
            href="https://discord.com/oauth2/authorize?client_id=1391067775077978214"
            style="color: #7289da; text-decoration: none; font-weight: bold;";
            >Install Discord Bot</a
          >
        </div>
        <div>
          <a href="/terms" style="color: #7289da; text-decoration: none">Terms Of Use</a>
          &amp;
          <a href="/terms/documentation.html" style="color: #7289da; text-decoration: none">API Docs</a>
          &amp;
          <a href="/terms/privacy.html" style="color: #7289da; text-decoration: none">Privacy Policy</a>
        <div>Coin System ¬© since 2025</div>
        </div>
    </div>
  </div>

  <!-- Main Screen -->
  <div id="mainScreen" class="screen">
    <div class="container">
      <div class="card">
        <strong id="dispUser" style="font-size: 18px"></strong>
        <div class="field" style="display:flex;align-items:center;gap:8px">
          <span id="dispUserId"></span>
          <!-- user copy button -->
          <button id="copyUserIdBtn" class="copy-btn small" title="Copy user id">Copy</button>
        </div>
        <div class="balance-box">
          <span id="dispBalance" class="highlight">0.00000000</span> coins
        </div>
        <div id="settingsBtn">‚öôÔ∏è</div>
        <div id="txBtn">üí≥</div>
        <div id="userBtn">üë§</div>
        <div class="nav">
          <button class="btn" data-screen="history">Home</button>
          <button class="btn" data-screen="card">Card</button>
          <button class="btn" data-screen="bills">Bills</button>
          <button class="btn" data-screen="transfer">Pay</button>
          <button class="btn" data-screen="claim">Claim</button>
        </div>
      </div>
      <div id="dynamic" class="card"></div>
      <div id="footerCard" class="card">
        <div>
          <a
            href="https://discord.com/oauth2/authorize?client_id=1391067775077978214"
            style="color: #7289da; text-decoration: none; font-weight: bold;";
            >Install Discord Bot</a
          >
        </div>
        <div>
          <a href="/terms" style="color: #7289da; text-decoration: none">Terms Of Use</a>
          &amp;
          <a href="/terms/documentation.html" style="color: #7289da; text-decoration: none">API Docs</a>
          &amp;
          <a href="/terms/privacy.html" style="color: #7289da; text-decoration: none">Privacy Policy</a>
        <div>Coin System ¬© since 2025</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const API = location.origin;
      let session = null,
        remaining = 0,
        lastTimestamp = null;

      /* --- utility: copy silently (no alerts) --- */
      async function copySilent(text) {
        if (!text && text !== 0) return;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(String(text));
            return true;
          }
        } catch (e) {
          // fallback below
        }
        // fallback: textarea selection
        try {
          const ta = document.createElement("textarea");
          ta.value = String(text);
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand && document.execCommand("copy");
          document.body.removeChild(ta);
          return !!ok;
        } catch (e) {
          return false;
        }
      }

      function authHeaders() {
        return { Authorization: "Bearer " + session.sessionId, "Content-Type": "application/json" };
      }
      function show(screen) {
        document.getElementById("loginModal").classList.toggle("active", screen === "login");
        document.getElementById("registerModal").classList.toggle("active", screen === "register");
        document.getElementById("mainScreen").classList.toggle("active", screen === "main");
        // remove any leftover tx copy button if switching screens
        const old = document.getElementById("txResultCopyBtn");
        if (old && old.parentNode) old.remove();
      }

      /* AUTH */
      async function login() {
        const u = document.getElementById("loginUser").value.trim();
        const p = document.getElementById("loginPass").value;
        try {
          const r = await fetch(API + "/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          if (!r.ok) throw "";
          const j = await r.json();
          if (j.sessionCreated && j.passwordCorrect) {
            session = { username: u, sessionId: j.sessionId, userId: j.userId };
            localStorage.setItem("session", JSON.stringify(session));
            init();
          } else {
            alert("Invalid credentials");
          }
        } catch {
          alert("Login error");
        }
      }
      async function doRegister() {
        const u = document.getElementById("regUser").value.trim();
        const p = document.getElementById("regPass").value;
        const cp = document.getElementById("regConfirm").value;
        if (!u || !p || !cp) return alert("Please fill all fields.");
        if (p !== cp) return alert("Passwords must match.");
        try {
          const r = await fetch(API + "/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error || "Register failed");
          alert("Account created! Please login.");
          show("login");
        } catch (e) {
          alert(e.message);
        }
      }

      /* --- load balance --- */
      async function loadBalance() {
        try {
          const r = await fetch(`${API}/api/user/${session.userId}/balance`, { headers: authHeaders() });
          if (r.ok) {
            const { coins = 0 } = await r.json();
            document.getElementById("dispBalance").textContent = Number(coins).toFixed(8);
          }
        } catch {}
      }

      /* --- main module loader --- */
      async function loadModule(mod) {
        // remove any leftover tx copy button before re-rendering dynamic
        const old = document.getElementById("txResultCopyBtn");
        if (old && old.parentNode) old.remove();

        const c = document.getElementById("dynamic");
        c.innerHTML = "";
        if (mod === "settings") {
          c.innerHTML =
            `<div style="display:flex;justify-content:space-between;margin-bottom:12px;">` +
            `<button class="btn-reset" onclick="doUnregister()">Unregister</button>` +
            `<button class="btn-reset" onclick="doLogout()">Logout</button>` +
            `</div>` +
            `<div class="field"><input id="newUser" placeholder="Username (optional)"></div>` +
            `<div class="field"><input id="newPass" type="password" placeholder="New Password"></div>` +
            `<div class="field"><input id="confirmPass" type="password" placeholder="Confirm Password"></div>` +
            `<button class="btn-reset" style="background:#ff5c5c;width:100%;" onclick="doChange()">Change</button>`;
          return;
        }
        if (mod === "backup") {
          c.innerHTML =
            `<div class="field"><input id="backupId" placeholder="Your backup ID"></div>` +
            `<div style="display:flex;justify-content:space-between;margin-bottom:12px;">` +
            `<button class="btn" id="doRestoreBtn">Restore</button>` +
            `<button class="btn" id="doCreateBackupBtn">Create Backup</button>` +
            `</div>` +
            `<hr style="margin:16px 0;border-color:#444"><h3>Your Backups</h3>`;
          try {
            const res = await fetch(API + "/api/backup/list", { method: "POST", headers: authHeaders() });
            if (res.ok) {
              const { backups } = await res.json();
              // create container for backups
              const listContainer = document.createElement("div");
              backups.forEach((code) => {
                const row = document.createElement("div");
                row.className = "bill";
                row.style.display = "flex";
                row.style.justifyContent = "space-between";
                row.style.alignItems = "center";
                row.style.gap = "12px";
                const text = document.createElement("div");
                text.textContent = code;
                const btns = document.createElement("div");
                btns.style.display = "flex";
                btns.style.gap = "8px";
                const copyBtn = document.createElement("button");
                copyBtn.className = "copy-btn small";
                copyBtn.textContent = "Copy";
                copyBtn.onclick = () => copySilent(code);
                btns.appendChild(copyBtn);
                row.appendChild(text);
                row.appendChild(btns);
                listContainer.appendChild(row);
              });
              c.appendChild(listContainer);
            }
          } catch {}
          // attach handlers for restore/create (they exist as global functions)
          setTimeout(() => {
            const rb = document.getElementById("doRestoreBtn");
            if (rb) rb.onclick = () => doRestore();
            const cb = document.getElementById("doCreateBackupBtn");
            if (cb) cb.onclick = () => doCreateBackup();
          }, 20);
          return;
        }
        if (mod === "transfer") {
          c.innerHTML =
            `<div class="field"><input id="amt" placeholder="Amount"></div>` +
            `<div class="field"><input id="toId" placeholder="Recipient ID"></div>` +
            `<button class="btn" onclick="doTransfer()">Pay User</button><hr style="margin:16px 0;border-color:#444">` +
            `<div class="field"><input id="billId" placeholder="Bill ID"></div>` +
            `<button class="btn" onclick="doPayBill()">Pay Bill</button>`;
          return;
        }
        if (mod === "history") {
          const r = await fetch(API + "/api/transactions?page=1", { headers: authHeaders() });
          if (!r.ok) return;
          const { transactions } = await r.json();
          transactions.forEach((t) => {
            const d = document.createElement("div");
            d.className = "tx";
            const left = document.createElement("div");
            left.className = "left";
            left.textContent =
              `date: ${new Date(t.date).toLocaleString("en-GB")}\n\n` +
              `from: ${t.from_id}\n\n` +
              `to: ${t.to_id}\n` +
              `amount: ${parseFloat(t.amount).toFixed(8)} coins\n\n` +
              `${t.id}`;
            const right = document.createElement("div");
            right.style.display = "flex";
            right.style.flexDirection = "column";
            right.style.gap = "8px";
            right.style.alignItems = "flex-end";
            // button to copy transaction id
            const copyBtn = document.createElement("button");
            copyBtn.className = "copy-btn small";
            copyBtn.textContent = "Copy ID";
            copyBtn.onclick = () => copySilent(t.id);
            right.appendChild(copyBtn);
            d.appendChild(left);
            d.appendChild(right);
            c.append(d);
          });
          return;
        }
        if (mod === "bills") {
          const r = await fetch(API + "/api/bill/list", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ page: 1 }),
          });
          if (!r.ok) return;
          const { toPay = [], toReceive = [] } = await r.json();
          const all = [...toPay, ...toReceive];
          if (!all.length) {
            c.innerHTML = `<div class="small">No bills found</div>`;
            return;
          }
          all.forEach((b) => {
            const div = document.createElement("div");
            div.className = "bill";
            const left = document.createElement("div");
            left.className = "left";
            left.innerHTML =
              `date: ${new Date(b.date).toLocaleString("en-GB")}<br>` +
              `from: ${b.from_id}<br>` +
              `to: ${b.to_id}<br>` +
              `amount: ${parseFloat(b.amount).toFixed(8)} coins<br><br>` +
              `${b.id}`;
            const right = document.createElement("div");
            right.style.display = "flex";
            right.style.flexDirection = "column";
            right.style.gap = "8px";
            right.style.alignItems = "flex-end";
            // copy bill id button
            const copyBtn = document.createElement("button");
            copyBtn.className = "copy-btn small";
            copyBtn.textContent = "Copy ID";
            copyBtn.onclick = () => copySilent(b.id);
            // pay button (existing behavior)
            const payBtn = document.createElement("button");
            payBtn.className = "btn";
            payBtn.textContent = "Pay";
            payBtn.onclick = () => payBillItem(b.id);
            right.appendChild(copyBtn);
            right.appendChild(payBtn);
            div.appendChild(left);
            div.appendChild(right);
            c.append(div);
          });
          return;
        }
        if (mod === "card") {
          const r = await fetch(API + "/api/card", { method: "POST", headers: authHeaders() });
          if (!r.ok) {
            c.innerHTML = `<div class="small">Error loading card</div>`;
            return;
          }
          const { cardCode } = await r.json();
          c.innerHTML =
            `<div id="cardDisplay"><div class="bank-card"><div class="magstripe"></div>` +
            `<div class="info"><p>${escapeHtml(session.userId)}</p><p>${escapeHtml(cardCode)}</p></div></div></div>` +
            // copy + reset inline: copy left, reset right
            `<div style="display:flex;gap:8px;margin-top:12px">` +
            `<div class="copy-inline">` +
            `<button id="copyCardUnderBtn" class="copy-btn small">Copy Card</button>` +
            `<button id="resetCardUnderBtn" class="copy-btn small red">Reset</button>` +
            `</div>` +
            `</div>` +
            `<hr style="margin:16px 0;border-color:#444">` +
            `<div class="field"><input id="billAmount" placeholder="Amount"></div>` +
            `<div class="field"><input id="billFrom" placeholder="From (User ID)"></div>` +
            `<button class="btn" onclick="doCreateBill()">Create Bill</button>`;
          // attach copy and reset handlers after injecting
          setTimeout(() => {
            const copyBtn = document.getElementById("copyCardUnderBtn");
            if (copyBtn) copyBtn.onclick = () => copySilent(cardCode);
            const resetBtn = document.getElementById("resetCardUnderBtn");
            if (resetBtn) resetBtn.onclick = () => resetCard();
          }, 20);
          return;
        }
        if (mod === "claim") {
          c.innerHTML =
            `<div style="display:flex;flex-direction:column;align-items:center;">` +
            `<h3 style="margin-bottom:16px;">Claim Coins</h3>` +
            `<button id="claimActionBtn" class="btn disabled" disabled>Claim</button>` +
            `<div style="height:1em;"></div>` +
            `<div id="claimTimer">00h 00m 00s</div>` +
            `<div id="lastClaimDate" style="margin-top:16px;font-size:12px;color:#aaa;">Last claim: ‚Äî</div>` +
            `</div>`;
          setupClaim(c);
          return;
        }
        if (mod === "txcheck") {
          // tx check UI: input + send + placeholder of 1 transaction (black)
          c.innerHTML =
            `<div style="display:flex;flex-direction:column;align-items:stretch;">` +
            `<h3 style="margin-bottom:12px;">Check Transaction</h3>` +
            `<div class="field"><input id="txIdInput" placeholder="Transaction ID"></div>` +
            `<div style="display:flex;justify-content:flex-end;margin-bottom:12px;">` +
            `<button class="btn" id="txCheckBtn">Check</button>` +
            `</div>` +
            `<div id="txResultWrapper">` +
            `<div id="txResult" class="single-tx-placeholder"><div id="txResultText" style="flex:1">‚Äî</div></div>` +
            `</div>` +
            `</div>`;

          document.getElementById("txCheckBtn").onclick = async function () {
            const txId = document.getElementById("txIdInput").value.trim();
            const box = document.getElementById("txResult");
            const textDiv = document.getElementById("txResultText");
            // remove previous internal copy button if any
            const prevBtn = document.getElementById("txResultCopyBtn");
            if (prevBtn && prevBtn.parentNode) prevBtn.remove();

            if (!txId) {
              textDiv.textContent = "Put a transaction ID";
              return;
            }
            textDiv.textContent = "Loading...";
            try {
              const res = await fetch(API + "/api/tx/" + encodeURIComponent(txId), {
                method: "GET",
                headers: authHeaders()
              });
              if (!res.ok) {
                textDiv.textContent = "invalid transaction";
                return;
              }
              const j = await res.json();
              const t = j.tx;
              const txt =
                `date: ${new Date(t.date).toLocaleString("en-GB")}\n\n` +
                `from: ${t.from}\n\n` +
                `to: ${t.to}\n\n` +
                `amount: ${parseFloat(t.amountCoins).toFixed(8)} coins\n\n` +
                `${t.id}`;
              textDiv.textContent = txt;
              // create a copy button inside the box (top-right)
              const copyBtn = document.createElement("button");
              copyBtn.id = "txResultCopyBtn";
              copyBtn.className = "copy-btn small";
              copyBtn.style.position = "absolute";
              copyBtn.style.top = "8px";
              copyBtn.style.right = "8px";
              copyBtn.textContent = "Copy ID";
              copyBtn.onclick = () => copySilent(t.id);
              box.appendChild(copyBtn);
            } catch (err) {
              console.error("‚ùå Error fetching tx:", err);
              textDiv.textContent = "invalid transaction";
            }
          };
          return;
        }
      }

      function setupClaim(container) {
        fetch(API + "/api/claim/status", { headers: authHeaders() })
          .then((r) => r.json())
          .then((j) => {
            remaining = j.cooldownRemainingMs;
            lastTimestamp = j.lastClaimTimestamp;
            const dateEl = container.querySelector("#lastClaimDate");
            if (lastTimestamp) {
              dateEl.textContent = "Last claim: " + new Date(lastTimestamp).toLocaleString("en-GB");
            }
            updateTimer();
          });
        function updateTimer() {
          const btn = container.querySelector("#claimActionBtn"),
            timer = container.querySelector("#claimTimer");
          if (remaining <= 0) {
            btn.disabled = false;
            btn.classList.remove("disabled");
            btn.classList.add("enabled");
            btn.onclick = doClaim;
            timer.textContent = "00h 00m 00s";
          } else {
            btn.disabled = true;
            btn.classList.remove("enabled");
            btn.classList.add("disabled");
            const h = Math.floor(remaining / 3600000),
              m = Math.floor((remaining % 3600000) / 60000),
              s = Math.floor((remaining % 60000) / 1000);
            timer.textContent = `${h}h ${m}m ${s}s`;
            remaining -= 1000;
            setTimeout(updateTimer, 1000);
          }
        }
      }

      /* A√á√ïES */
      window.doTransfer = async function () {
        const amt = parseFloat(document.getElementById("amt").value),
          toId = document.getElementById("toId").value.trim();
        await fetch(API + "/api/transfer", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ toId, amount: amt }),
        });
        loadBalance();
      };
      window.doPayBill = async function () {
        const billId = document.getElementById("billId").value.trim();
        await fetch(API + "/api/bill/pay", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ billId }),
        });
        loadModule("bills");
      };

      // per-item pay button (same endpoint)
      window.payBillItem = async function (billId) {
        if (!confirm("Confirm pay bill " + billId + " ?")) return;
        try {
          const res = await fetch(API + "/api/bill/pay", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ billId }),
          });
          if (!res.ok) {
            const j = await res.json();
            alert("Error: " + (j.error || "unknown"));
          } else {
            loadModule("bills");
            loadBalance();
          }
        } catch (e) {
          alert("Error paying");
        }
      };

      window.doCreateBill = async function () {
        const amount = parseFloat(document.getElementById("billAmount").value),
          fromId = document.getElementById("billFrom").value.trim();
        if (!amount || !fromId) return alert("Fill Amount and From");
        const res = await fetch(API + "/api/bill/create", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ fromId, toId: session.userId, amount }),
        });
        if (res.ok) loadModule("bills");
        else {
          const j = await res.json();
          alert(`Error: ${j.error || "unknown"}`);
        }
      };

      window.resetCard = async function () {
        await fetch(API + "/api/card/reset", { method: "POST", headers: authHeaders() });
        loadModule("card");
      };

      window.doRestore = async function () {
        const bid = document.getElementById("backupId").value.trim();
        if (!bid) return alert("Provide backup ID");
        await fetch(API + "/api/backup/restore", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ backupId: bid }),
        });
        loadModule("backup");
        loadBalance();
      };

      window.doCreateBackup = async function () {
        await fetch(API + "/api/backup/create", { method: "POST", headers: authHeaders() });
        loadModule("backup");
      };

      window.doUnregister = async function () {
        await fetch(API + "/api/account/unregister", { method: "POST", headers: authHeaders() });
        show("login");
      };

      window.doLogout = async function () {
        await fetch(API + "/api/logout", { method: "POST", headers: authHeaders() });
        localStorage.removeItem("session");
        show("login");
      };

      window.doChange = async function () {
        const nu = document.getElementById("newUser").value.trim(),
          np = document.getElementById("newPass").value,
          cp = document.getElementById("confirmPass").value;
        if (!np || np !== cp) return alert("Passwords must match");
        await fetch(API + "/api/account/change", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ username: nu || undefined, password: np }),
        });
        alert("Credentials updated, please log in again");
        doLogout();
      };

      window.doClaim = async function () {
        try {
          const res = await fetch(API + "/api/claim", { method: "POST", headers: authHeaders() });
          const j = await res.json();
          if (res.ok) {
            alert(`üéâ You claimed ${j.claimed} coins!`);
            loadBalance();
            loadModule("claim");
          } else if (res.status === 429) {
            alert(`‚è≥ Cooldown active. Next claim in ${j.nextClaimInMs} ms`);
          } else {
            alert(`‚ùå Claim error: ${j.error || "unknown"}`);
          }
        } catch (err) {
          console.error("‚ùå Claim failed:", err);
          alert("‚ùå Claim failed. Try again later.");
        }
      };

      // listeners
      document.getElementById("loginBtn").onclick = login;
      document.getElementById("goRegisterBtn").onclick = () => show("register");
      document.getElementById("registerBtn").onclick = doRegister;
      document.getElementById("backBtn").onclick = () => show("login");
      document.querySelectorAll(".nav .btn").forEach((b) => (b.onclick = () => loadModule(b.dataset.screen)));
      document.getElementById("settingsBtn").onclick = () => loadModule("settings");
      document.getElementById("userBtn").onclick = () => loadModule("backup");
      document.getElementById("txBtn").onclick = () => loadModule("txcheck");

      // user ID copy button
      document.getElementById("copyUserIdBtn").onclick = function () {
        if (session && session.userId) copySilent(session.userId);
      };

      function init() {
        const s = localStorage.getItem("session");
        if (!s) return show("login");
        session = JSON.parse(s);
        if (!session.sessionId) return show("login");
        document.getElementById("dispUser").textContent = session.username;
        document.getElementById("dispUserId").textContent = session.userId;
        show("main");
        loadBalance();
        setInterval(loadBalance, 2000);
        loadModule("history");
      }

      // small helpers
      function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str).replace(/[&<>"]/g, function (c) {
          return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
        });
      }
      function escapeForInline(str) {
        if (!str && str !== 0) return "";
        return String(str).replace(/'/g, "\\'");
      }

      init();
    })();
  </script>
</body>
</html>
